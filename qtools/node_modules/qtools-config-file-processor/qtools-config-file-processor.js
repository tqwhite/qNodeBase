'use strict';

//START OF moduleFunction() ============================================================

var moduleFunction = function(qtools) {
	const path=require('path');
	const arrayItemsName = 'arrayItems';
	
	const upgradeConfigItems = config => {
		const outObj = qtools.clone(config);
		for (var i in config[arrayItemsName]) {
			if (!config[arrayItemsName].hasOwnProperty(i)) {
				continue;
			}

			var element = config[arrayItemsName][i];
			qtools.putSurePath(outObj, element, 'placeholder');

			const inObj = qtools.getSurePath(config, element, []);

			const outArray = [];
			for (i in inObj) {
				outArray[i] = inObj[i];
			}
			qtools.putSurePath(outObj, element, outArray);
		}

		return outObj;
	};

	const findGoodConfigPath=(pathParm, workingDirectory)=>{
		let result=qtools.realPath(pathParm);
		if (result){
			return result;
		}
		else if (workingDirectory){
			
		while (workingDirectory!='/' && !qtools.realPath(path.join(workingDirectory, pathParm))){
			workingDirectory=path.dirname(workingDirectory);
		}
		return workingDirectory!='/'?path.join(workingDirectory, pathParm):'';
		}
		
		
		return result;
	}
	
	let multiIni = require('multi-ini');
	multiIni = new multiIni.Class({
		filters: [
			value => {
				if (value == /^''$/) {
					return value;
				}

				if (value.match(/^''/)) {
					return value.replace(/^''/, '');
				}

				switch (value) {
					case 'true':
						return true;
					case 'false':
						return false;
					case 'null':
						return null;
				}

				if (!isNaN(+value)) {
					return +value;
				}

				return value;
			}
		]
	});
	
	qtools.configFileProcessor = multiIni;
	qtools.configFileProcessor.upgradeConfigItems = upgradeConfigItems;
	
	qtools.configFileProcessor.getConfig = (configPath, workingDirectory) => {
		const validConfigPath=findGoodConfigPath(configPath, workingDirectory);
		if (!validConfigPath){
			qtools.logError(`no config file found ${configPath}`)
			return;
		}
		else{
			const config = qtools.configFileProcessor.read(validConfigPath); //this is multi-ini with post-processing
			return qtools.configFileProcessor.upgradeConfigItems(config);
		}
	};
	qtools.configFileProcessor.setArrayItemsName = newArrayItemsName => {
		arrayItemsName = newArrayItemsName;
	};
};

//END OF moduleFunction() ============================================================

module.exports = moduleFunction;
//module.exports = new moduleFunction();

